# Определение пакетов для удаления
$remove_appx = @("WindowsDefender");
$provisioned = Get-AppxProvisionedPackage -Online;
$appxpackage = Get-AppxPackage -AllUsers;
$eol = @();
$store = 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Appx\AppxAllUserStore';
$users = @('S-1-5-18');

if (Test-Path $store) {
    $users += $((Get-ChildItem $store -ErrorAction 0 | Where-Object { $_ -like '*S-1-5-21*' }).PSChildName)
}

foreach ($choice in $remove_appx) {
    if ('' -eq $choice.Trim()) { continue }

    # Удаление подготовленных пакетов
    foreach ($appx in $($provisioned | Where-Object { $_.PackageName -like "*$choice*" })) {
        $next = $false;
        # Пропуск определенных пакетов, если необходимо
        # foreach ($no in $skip) { if ($appx.PackageName -like "*$no*") { $next = $true } }; if ($next) { continue }

        $PackageName = $appx.PackageName;
        $PackageFamilyName = ($appxpackage | Where-Object { $_.Name -eq $appx.DisplayName }).PackageFamilyName

        New-Item "$store\Deprovisioned\$PackageFamilyName" -Force > $null;
        foreach ($sid in $users) {
            New-Item "$store\EndOfLife\$sid\$PackageName" -Force > $null
        }
        $eol += $PackageName;

        Dism /online /Set-NonRemovableAppPolicy /PackageFamily:$PackageFamilyName /NonRemovable:0 > $null;
        Remove-AppxProvisionedPackage -PackageName $PackageName -Online -AllUsers > $null;
    }

    # Удаление установленных пакетов
    foreach ($appx in $($appxpackage | Where-Object { $_.PackageFullName -like "*$choice*" })) {
        $next = $false;
        # Пропуск определенных пакетов, если необходимо
        # foreach ($no in $skip) { if ($appx.PackageFullName -like "*$no*") { $next = $true } }; if ($next) { continue }

        $PackageFullName = $appx.PackageFullName;

        New-Item "$store\Deprovisioned\$appx.PackageFamilyName" -Force > $null;
        foreach ($sid in $users) {
            New-Item "$store\EndOfLife\$sid\$PackageFullName" -Force > $null
        }
        $eol += $PackageFullName;

        Dism /online /Set-NonRemovableAppPolicy /PackageFamily:$appx.PackageFamilyName /NonRemovable:0 > $null;
        Remove-AppxPackage -Package $PackageFullName -AllUsers > $null;
    }
}

# Удаление политик безопасности WiSiPolicy.p7b
Remove-Item -LiteralPath "$((Get-Partition | Where-Object IsSystem).AccessPaths[0])Microsoft\Boot\WiSiPolicy.p7b" -ErrorAction SilentlyContinue
Remove-Item -LiteralPath "$env:windir\System32\CodeIntegrity\WiSiPolicy.p7b" -ErrorAction SilentlyContinue
Remove-Item -LiteralPath "$env:windir\Boot\EFI\wisipolicy.p7b" -ErrorAction SilentlyContinue
Remove-Item -Path "$env:windir\WinSxS" -Include *winsipolicy.p7b* -Recurse -ErrorAction SilentlyContinue
